name: ğŸ”„ Lovable Sync Definitivo

on:
  push:
    branches: [main]
  schedule:
    # Executa a cada 15 minutos (mais frequente)
    - cron: "*/15 * * * *"
  workflow_dispatch: # Permite execuÃ§Ã£o manual

permissions:
  contents: write
  actions: read

env:
  NODE_VERSION: "18"

jobs:
  lovable-sync:
    runs-on: ubuntu-latest
    name: SincronizaÃ§Ã£o Lovable

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          echo "âœ… DependÃªncias instaladas"

      - name: ğŸ” Validate Lovable Token
        run: |
          if [ -z "${{ secrets.LOVABLE_TOKEN }}" ]; then
            echo "âŒ LOVABLE_TOKEN nÃ£o configurado!"
            echo "ğŸ“‹ Configure em: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "ğŸ’¡ Execute: npm run lovable:configure-token"
            exit 1
          else
            echo "âœ… LOVABLE_TOKEN configurado"
            echo "Token preview: ${LOVABLE_TOKEN:0:8}...${LOVABLE_TOKEN: -4}"
          fi
        env:
          LOVABLE_TOKEN: ${{ secrets.LOVABLE_TOKEN }}

      - name: ğŸš€ Execute Lovable Sync
        run: |
          echo "ğŸ”„ Iniciando sincronizaÃ§Ã£o completa..."
          node scripts/prepare-lovable.js
          echo "âœ… PreparaÃ§Ã£o concluÃ­da"
        env:
          LOVABLE_TOKEN: ${{ secrets.LOVABLE_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”„ Force Sync with Webhook
        run: |
          echo "ğŸŒ Executando sincronizaÃ§Ã£o forÃ§ada..."
          node scripts/force-lovable-sync.js
          echo "âœ… SincronizaÃ§Ã£o forÃ§ada concluÃ­da"
        env:
          LOVABLE_TOKEN: ${{ secrets.LOVABLE_TOKEN }}

      - name: ğŸ“ Update Sync Status
        run: |
          CURRENT_TIMESTAMP=$(date +%s)
          echo "â° Timestamp: $CURRENT_TIMESTAMP"

          # Atualizar .lovable-trigger
          echo "LOVABLE_FORCE_SYNC=$CURRENT_TIMESTAMP" > .lovable-trigger
          echo "GITHUB_WORKFLOW_RUN=${{ github.run_id }}" >> .lovable-trigger
          echo "SYNC_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> .lovable-trigger

          # Atualizar .lovable se existir
          if [ -f ".lovable" ]; then
            node -e "
              const fs = require('fs');
              try {
                const config = JSON.parse(fs.readFileSync('.lovable', 'utf8'));
                config.sync = config.sync || {};
                config.sync.timestamp = $CURRENT_TIMESTAMP;
                config.sync.githubRunId = '${{ github.run_id }}';
                config.sync.lastWorkflowSync = new Date().toISOString();
                config.lastUpdate = new Date().toISOString();
                config.version = '2.2.$CURRENT_TIMESTAMP';
                config.tokenConfigured = true;
                fs.writeFileSync('.lovable', JSON.stringify(config, null, 2));
                console.log('âœ… ConfiguraÃ§Ã£o .lovable atualizada com workflow info');
              } catch (error) {
                console.log('âš ï¸ Erro ao atualizar .lovable:', error.message);
              }
            "
          fi

          # Atualizar status
          cat > .lovable-status << EOF
          {
            "lastSync": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "method": "github-workflow",
            "status": "sync-completed",
            "timestamp": $CURRENT_TIMESTAMP,
            "workflowRunId": "${{ github.run_id }}",
            "tokenConfigured": true
          }
          EOF

      - name: ğŸ”” Notify Lovable API
        run: |
          echo "ğŸ“¡ Notificando Lovable sobre sincronizaÃ§Ã£o..."

          # URLs de webhook para tentar
          WEBHOOK_URLS=(
            "https://api.lovable.dev/v1/sync/github"
            "https://hooks.lovable.dev/github/sync"
            "https://api.lovable.dev/webhook/github-sync"
            "https://sync.lovable.dev/api/github"
          )

          SUCCESS_COUNT=0

          for url in "${WEBHOOK_URLS[@]}"; do
            echo "ğŸ”— Tentando: $url"
            
            response=$(curl -s -w "%{http_code}" -X POST "$url" \
              -H "Authorization: Bearer ${{ secrets.LOVABLE_TOKEN }}" \
              -H "Content-Type: application/json" \
              -H "User-Agent: GitHub-Actions-Lovable-Sync/2.0" \
              -d '{
                "repository": "${{ github.repository }}",
                "branch": "${{ github.ref_name }}",
                "commit": "${{ github.sha }}",
                "timestamp": '"$(date +%s)"',
                "workflow_run_id": "${{ github.run_id }}",
                "event": "push"
              }' \
              --connect-timeout 10 \
              --max-time 30 \
              -o /tmp/webhook_response.json)
            
            status_code="${response: -3}"
            
            if [ "$status_code" = "200" ] || [ "$status_code" = "201" ] || [ "$status_code" = "202" ]; then
              echo "âœ… Sucesso em $url (${status_code})"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "âš ï¸ Falha em $url (${status_code})"
              if [ -f /tmp/webhook_response.json ]; then
                cat /tmp/webhook_response.json 2>/dev/null || true
              fi
            fi
          done

          echo "ğŸ“Š Webhooks bem-sucedidos: $SUCCESS_COUNT/${#WEBHOOK_URLS[@]}"

          if [ $SUCCESS_COUNT -gt 0 ]; then
            echo "âœ… Pelo menos um webhook funcionou"
          else
            echo "âš ï¸ Nenhum webhook funcionou, mas sincronizaÃ§Ã£o pode ainda estar ativa"
          fi
        env:
          LOVABLE_TOKEN: ${{ secrets.LOVABLE_TOKEN }}

      - name: ğŸ’¾ Commit Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Lovable Sync Bot"

          # Verificar se hÃ¡ alteraÃ§Ãµes
          if [ -n "$(git status --porcelain)" ]; then
            git add .lovable-trigger .lovable .lovable-status
            git commit -m "ğŸ”„ Lovable Auto-Sync: $(date -u +%Y-%m-%d\ %H:%M:%S) [run:${{ github.run_id }}]"
            git push origin main
            echo "âœ… AlteraÃ§Ãµes commitadas e enviadas"
          else
            echo "â„¹ï¸ Nenhuma alteraÃ§Ã£o para commitar"
          fi

      - name: ğŸ§ª Validate Sync
        run: |
          echo "ğŸ” Validando sincronizaÃ§Ã£o..."

          if [ -f ".lovable" ]; then
            echo "âœ… Arquivo .lovable existe"
            node -e "
              const config = JSON.parse(require('fs').readFileSync('.lovable', 'utf8'));
              console.log('ğŸ“Š Projeto:', config.name || 'N/A');
              console.log('ğŸ“Š ID:', config.id || 'N/A');
              console.log('ğŸ“Š Ãšltima atualizaÃ§Ã£o:', config.lastUpdate || 'N/A');
              console.log('ğŸ“Š Token configurado:', config.tokenConfigured ? 'âœ…' : 'âŒ');
            "
          else
            echo "âš ï¸ Arquivo .lovable nÃ£o encontrado"
          fi

          if [ -f ".lovable-status" ]; then
            echo "âœ… Status de sincronizaÃ§Ã£o:"
            cat .lovable-status
          fi

          echo "ğŸ‰ ValidaÃ§Ã£o de sincronizaÃ§Ã£o concluÃ­da!"

      - name: ğŸ“Š Sync Summary
        run: |
          echo "ğŸ“‹ RESUMO DA SINCRONIZAÃ‡ÃƒO"
          echo "========================="
          echo "ğŸ”— RepositÃ³rio: ${{ github.repository }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸƒ Workflow Run: ${{ github.run_id }}"
          echo "â° Timestamp: $(date -u +%Y-%m-%d\ %H:%M:%S)"
          echo "ğŸ”‘ Token: $([ -n "${{ secrets.LOVABLE_TOKEN }}" ] && echo "âœ… Configurado" || echo "âŒ Ausente")"
          echo "========================="
